openapi: 3.0.0
info:
  title: Formulary Placement API
  description: API to query drug placement in a formulary for a given year, utilizing OpenSearch and Azure OpenAI for responses.
  version: 1.0.0
servers:
  - url: https://your-api-gateway-url.amazonaws.com/prod
    description: Production Server

paths:
  /query:
    post:
      summary: Query formulary placement
      description: Retrieve information about drug placement in a formulary for a given year.
      operationId: queryFormularyPlacement
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/QueryRequest"
      responses:
        "200":
          description: Successful response with AI-generated insights.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QueryResponse"
        "400":
          description: Invalid request format.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  
  /query:
    get:
      summary: Retrieve all chats for a user
      description: Fetches all chat history available for the user.
      operationId: getAllChats
      parameters:
        - name: userId
          in: query
          required: true
          schema:
            type: string
          description: Unique identifier of the user.
      responses:
        "200":
          description: Successfully retrieved chat history.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChatHistoryResponse"
        "400":
          description: Invalid request format.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  
  /query:
    delete:
      summary: Clear all chat history
      description: Deletes all chat history for the given user.
      operationId: clearAllChats
      parameters:
        - name: userId
          in: query
          required: true
          schema:
            type: string
          description: Unique identifier of the user.
      responses:
        "200":
          description: Successfully cleared chat history.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    description: Confirmation message.
        "400":
          description: Invalid request format.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  schemas:
    QueryRequest:
      type: object
      properties:
        query:
          type: string
          description: The user query about drug placement.
        history:
          type: array
          items:
            type: object
            properties:
              role:
                type: string
                enum: [user, assistant]
              content:
                type: string
          description: Conversation history to maintain context.

    QueryResponse:
      type: object
      properties:
        response:
          type: string
          description: AI-generated response in natural language.
        additional_info:
          type: string
          description: Pagination information if more results are available.

    ChatHistoryResponse:
      type: object
      properties:
        userId:
          type: string
          description: Unique identifier of the user.
        chats:
          type: array
          items:
            type: object
            properties:
              conversationId:
                type: string
                description: Unique identifier of the conversation.
              messages:
                type: array
                items:
                  type: object
                  properties:
                    role:
                      type: string
                      enum: [user, assistant]
                    content:
                      type: string
                description: Messages exchanged in the chat.

    ErrorResponse:
      type: object
      properties:
        error_code:
          type: string
          description: The error code identifier.
        error_message:
          type: string
          description: Detailed error message explaining the issue.
        details:
          type: object
          description: Additional details about the error.
          additionalProperties:
            type: string
